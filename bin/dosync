#!/usr/bin/env bash
# ============================================================================= #
#  ➜ ➜ ➜ TRAP
# ============================================================================= #
trap 'exit' SIGINT SIGQUIT SIGTSTP

DOTFILES=".dotfiles"
SYNCFILE="$HOME/$DOTFILES/syncrc"
GITOPT="-q"
GITSUB="--quiet"
GITSUBOPT="--quiet"
INSTALL_FONTS="${INSTALL_FONTS:-no}"
INSTALL_DEPS="${INSTALL_DEPS:-no}"
INSTALL_NERD="${INSTALL_NERD:-no}"
NOTTY="${NOTTY:-no}"

if [ ! -z "$TERM" ]; then
    export TERM="xterm-256color"
fi

isdotdir() {
    if [ -d "$HOME/$DOTFILES" ]; then
        cd "$HOME/$DOTFILES"
    else
        rm -rf "$HOME/$DOTFILES"
        git clone --quiet --depth=1 "$ORIGIN" "$HOME/$DOTFILES"
    fi
}
isgitlayout() {
    if [[ ! -d .git ]]; then
        echo "Not a git repository"
        exit 1
    fi
}

initlocal() {
    isdotdir
    isgitlayout
    # init the main repo
    git submodule $GITSUB update --init --recursive
    cd
}

getgitorigin() {
    isdotdir
    if [[ -d .git ]]; then
        ORIGIN=$(git config -l | grep remote.origin.url | awk -F'=' '{print $2}')
    fi
    cd
}

checkin() {
    gitcommit && gitpush
}

gitpull() {
    getgitorigin
    isdotdir
    isgitlayout
    echo "Pulling latest changes from $ORIGIN"
    git pull $GITOPT
    echo "Pulling latest changes for submodules"
    # Required if a submodule origin changed
    git submodule $GITSUBOPT sync
    git submodule $GITSUBOPT foreach --recursive git fetch
    git submodule $GITSUBOPT update --init --recursive
    cd
}

gitcommit() {
    getgitorigin
    isdotdir
    echo "Commiting latest changes to the repository"
    git commit -a $GITOPT
    cd
}

gitpush() {
    getgitorigin
    isdotdir
    echo "Pushing changes upstream to $ORIGIN" &&
        git push $GITOPT
    cd
}

if [ ! -f "$HOME/$DOTFILES/lib/utilities.sh" ]; then
    getgitorigin
    isdotdir
    gitpull

    cd lib || exit 1
    echo "Updating library"
    git checkout master
    git pull $GITOPT origin master
    cd ..
fi

source "$HOME/$DOTFILES/lib/utilities.sh"
source "$HOME/$DOTFILES/lib/installer.sh"

NEVER_ROOT
# ============================================================================= #

# ============================================================================= #

vscodesettings() {
    if [ "$(uname -s)" = "Darwin" ]; then
        vscodepath="$HOME/Library/Application Support/Code/User"
        vscodeplatform=mac
    else
        vscodepath="$HOME/.config/Code/User"
        vscodeplatform=linux
    fi
    mkdir -p "$vscodepath"
    SYMLINK ".vscode-$vscodeplatform.settings.json" "$vscodepath/settings.json"
    SYMLINK ".vscode-$vscodeplatform.keybindings.json" "$vscodepath/keybindings.json"
}

removebrokenlinks() {
    find $HOME -maxdepth 1 -name ".*" -type l | while read f; do if [ ! -e "$f" ]; then rm -f "$f"; fi; done
}

sync_options() {
    # Skip setup if the user wants or stdin is closed (not running interactively).
    if [ $NOTTY = yes ]; then
        export overwrite_all='false' backup_all='true' skip_all='false'
    else
        export overwrite_all='false' backup_all='false' skip_all='false'
    fi

    if [ $INSTALL_FONTS = yes ]; then

        NOTIFY "Installing fonts"
        mkdir -p ~/.local/share/fonts
        cd ~/.local/share/fonts
        git clone https://github.com/powerline/fonts.git --depth=1
        cd fonts || return
        ./install.sh
        cd .. || return
        rm -rf fonts
        exit 0
    fi
    if [ $INSTALL_NERD = yes ]; then

        NOTIFY "Installing fonts"
        mkdir -p ~/.local/share/NerdFonts
        cd ~/.local/share/fonts
        git clone --depth 1 https://github.com/ryanoasis/nerd-fonts.git && cd nerd-fonts
        #wget https://raw.githubusercontent.com/ryanoasis/nerd-fonts/master/install.sh &&
        chmod +x install.sh && ./install.sh
        exit 0
        #      git clone --depth=1 https://github.com/romkatv/nerd-fonts.git
        #      cd nerd-fonts
        #      ./build 'Meslo/S/*'
        #      cd ..
        #      rm -rf nerd-fonts
    fi
    if [ $INSTALL_DEPS = yes ]; then
        case $OS in
        'Arch')
            UPDATE
            INSTALL "curl wget ruby python chromaprint lsb-release"
            ;;
        'Ubuntu')
            UPDATE
            INSTALL "curl wget ruby python chroma lsb-release"
            ;;
        'Debian')
            UPDATE
            INSTALL "curl wget ruby python chroma lsb-release"
            ;;
        'Armbian')
            UPDATE
            INSTALL "curl wget ruby python chroma lsb-release"
            ;;
        'Raspbian')
            UPDATE
            INSTALL "curl wget ruby python chroma lsb-release"
            ;;
        esac
        exit 0
    fi
    #    # If this user's login shell is already "zsh", do not attempt to switch.
    #    if [ "$(basename -- "$SHELL")" = "zsh" ]; then
    #        return
    #    fi
}

sync_config() {
    if [[ ! -s $SYNCFILE ]]; then
        if [[ -s $HOME/$DOTFILES/syncrc ]]; then
            SYNCFILE="$HOME/$DOTFILES/syncrc"
        else
            echo "File syncrc doesnt exist, exiting"
            exit 1
        fi
    fi
}

files_list() {
    SRCFILES="$(sed -n '/\[files\]/,/\[endfiles\]/p' $SYNCFILE | grep -v '^\[.*files]' | grep -v ^#)"
    if [[ -z "$SRCFILES" ]]; then
        echo "Specify files to sync in syncrc file"
        exit 1
    fi
}

get_file() {
    srcfile="$(echo $file | awk -F: '{print $1}')"
    dstfile="$(echo $file | awk -F: '{print $2}')"
    dotsrc="$HOME/$DOTFILES/$srcfile"

    if [[ $dstfile = "" ]]; then
        dstfile=".$(basename "$srcfile")"
    fi
    dotfile="$HOME/$dstfile"
}
run_install() {
    # Run as unattended if stdin is not a tty
    if [ ! -t 0 ]; then
        NOTTY=yes
    fi

    while [ $# -gt 0 ]; do
        case $1 in
        -unattended) NOTTY=yes ;;
        -powerline-fonts) INSTALL_FONTS=yes ;;
        -nerd-complete) INSTALL_NERD=yes ;;
        -deps) INSTALL_DEPS=yes ;;
        -u)
            gitpull
            exit 0
            ;;
        -c)
            gitcommit
            exit 0
            ;;
        -p)
            gitpush
            exit 0
            ;;
        -cp)
            checkin
            exit 0
            ;;
        esac
        shift
    done

    removebrokenlinks
    sync_options "$@"
    sync_config "$@"
    files_list "$@"
    for file in $SRCFILES; do
        get_file "$file"
        SYMLINK "$dotsrc" "$dotfile"
    done
    exit 0
}
while true; do
    run_install "$@"
done
