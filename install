#!/usr/bin/env bash
# ============================================================================= #
#  ➜ ➜ ➜ TRAP
# ============================================================================= #
trap 'exit' SIGINT SIGQUIT SIGTSTP

update_repo() {
    DOTDIR="$HOME/.dotfiles"
    REPO="https://github.com/ss-o/dotfiles"
    if [ -d "$DOTDIR/.git" ]; then
        cd "$DOTDIR"
        git pull --quiet --rebase origin main || exit 1
    else
        rm -rf "$DOTDIR"
        git clone --quiet --depth=1 "$REPO" "$DOTDIR"
    fi
    cd "$DOTDIR"

    git submodule --quiet sync --recursive
    git submodule --quiet update --init --recursive

    cd lib || exit 1
    git checkout master
    cd .. || return
}

collect_info() {
    [ -n "$(echo $BASH)" ] && usingbash='yes' || usingbash='no'
    if [ $usingbash = yes ]; then
        echo "Using bash"
    fi
    [ -n "$(echo $ZSH)" ] && usingzsh='yes' || usingzsh='no'
    if [ $usingzsh = yes ]; then
        echo "Using zsh"
    fi

}

prepare_env() {
    source "lib/utilities.sh"

    TITLE "Device:"
    collect_info
    CUTLINE
    BOLDBLUE "$DISTRO | $UARCH | $UKERNEL"
    CUTLINE

}

main() {
    update_repo
    prepare_env

    TITLE "Running auto install"
    CUTLINE
    ./bin/dosync
    CUTLINE
    exec "zsh"
    exit 0

}
while true; do
    main "$@"
done
